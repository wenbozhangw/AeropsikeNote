## Cold start

- appeals_tx_remaining
- strong-consistency
- DurableDeletes
- re_repl_success
- dead_partitions

### When Aerospike cold restarts
关闭后，在以下情况下，Aerospike将重建主索引，该索引将由企业版存储在共享内存中：

- 社区版始终为 cold start，因为 fast restart 功能是企业版独有的功能。
- 意外停止后（例如，分段错误，内存不足情况或内核冻结）。
- 服务器重启后（例如，由于内核升级或添加RAM）。
- 对于 3.15.1.3 之前的服务器版本，如果已为命名空间配置`data-in-memory true`。
- 使用"cold start"命令行选项强制执行冷启动。
- 更改`partition-tree-sprigs`的值。
- 如果适用，作为预期升级路径的一部分————例如，升级到版本 4.2.0.2。

参阅 [何时不发生 fast restart?](../fast-restart/FastRestart.md) 获取更多详情。

### Impact of cold restart
冷启动后，将从存储中重新填充索引。设备/文件上可能存在数据的多个副本，具体取决于更新频率以及保留旧数据的块是否尚未进行碎片整理并随后被新数据覆盖。这是冷重启的一些后果：

- Aerospike守护程序的启动时间要长的多（与快速重启相比-仅适用于企业版）。如果在冷启动期间触发逐出，则可能会加剧这种情况。
- [非持久删除的](../durable-deletes/DurableDeletes.md)记录可能会还原为较旧的版本。
- 运行 [strong-consistency]() 启动的命名空间时，冷启动可能会产生进一步的影响。
  
  - 所有记录将被标记为未复制（请参阅[appeals_tx_remaining]()统计信息）。
    
    - 单节点上未复制的记录不会产生产生重大影响，因为在迁移开始之前应迅速解决它们（检查当前的主数据库）。
    - 在多个节点被冷重启的情况下，在这些节点上具有所有名单副本的分区将会导致额外的延迟，因为它将需要对未[复制](re_repl_success)的记录进行初始 transaction 以[重新复制](re_repl_success)该记录。
  - 从不正常的关机（例如断电）中恢复时，分区将被标记为不可信，将其从名单有效副本中排除（例如，不计入多数）。
    
    - 在后续的网络分区的情况下，这将降低整体可用性（直至迁移完成）。
    - 如果有多个节点在非正常关机后冷重启，则在重新形成完整名单（请参阅[dead_partitions]()度量标准）时，在这些节点上具有所有名单副本的分区将被标记为无效。
    
### Different use cases to consider
为了清楚地了解后果，您需要量化服务器上应用程序的数据类型和用例。

可以根据每个命名空间的特定用法来应用一下详情信息。

**始终建议您在维护之前备份集群上的数据，尤其是在将触发冷启动的情况下。**

1. 数据自然过期，并且没有缩短过期时间或永久删除任何记录
  
    这是最好的情况。以下是所需的确切条件：
   
    - 使用持久删除策略专门删除记录
    - 设置了 ttl 的记录的过期时间永远没有被缩短
    - 记录从未被驱逐过
    
    在这种情况下，冷启动将重新加载以前存在的相同数据。持久删除或过期的数据将不会恢复。
   
2. 非持久的删除，逐出的数据或缩短其到期时间的记录

    这是此情况的条件：
   
    - 没有持久删除策略的记录已被删除。
    - 在Community Edition中，记录已通过truncate或truncate-namespace info命令删除 。请注意，truncate在企业版中是持久的。
    - 使用 ttl 设置的记录的到期时间缩短。
    
    这是处理冷启动而不带回以前删除的记录的方法。

如本页前面所述，始终建议在维护之前备份群集上的数据，尤其是在触发冷重启时。

 **2a 在开始备份之前，手动清理节点的持久性存储**

 命名空间的复制因子至少为 2 以上

  1. 清理持久性存储:

      - 如果使用文件进行持久化，则只需删除该文件。
      - 如果使用 raw device (在一个块设备安装到一个节点之前，对该设备的访问通常是作为一个线性的无结构的字节流来访问的，
        称为“原始设备(raw device)”。设备上的文件系统是不可访问的。经过安装以后，设备上的文件系统
        就以访问了。)，使用 `dd` 命令或`blkdiscard`命令。
        
  2. 将空节点引入集群。
  3. 等待迁移完成(它将完全重新填充该节点上的数据)，然后再继续下一个节点。

  **2b 使用clod-start-empty配置参数**
  命名空间的复制因子至少为 2 以上
  
   [cold-start-empty]()配置参数将指示服务器在冷启动时忽略磁盘上的数据。然后，迁移将重新平衡整个及群众的数据并重新填充该节点。因此，在继续下一个节点之前，必须等待迁移完成。一旦以`cold-start-empty true`重启了节点，通常不建议删除该配置，而不必按照(a)中所述完全"清理"持久化设备。

  请注意，尽管持久性存储上的数据将被忽略，但不会将其从设备中删除。因此，随后的冷启动可能会恢复较旧的记录(如果`cold-start-empty`被设置为 false )。如果将cold-start-empty设置为false，则在多个节点以接近的间隔（在迁移完成之前）冷重启时，可以防止数据不可用（以及潜在的数据丢失）。
  
  **2c 按原样冷重启节点**

  如果用例可以处理被删除记录的潜在恢复，那么节点可以被冷重启，而无需任何进一步操作。
  
由于可以恢复已删除的记录，incident可能会加载比以前存在的数据更多的数据。

如果发生冷重启，导致出现逐出现象（磁盘或内存高水位标记被破坏），则启动时间可能会打打增加。有关[加速冷重启驱逐](https://discuss.aerospike.com/t/faq-what-options-are-available-to-speed-up-cold-start-eviction/3480)的详细信息，请参阅以下文章。

如果在冷重启期间驱逐无效（例如，记录未设任何TTL），则可能会违反 `stop-writes-pct` 阈值。在这种情况下，节点将终止并且无法完成启动。

###

若果您希望使用 systemd 和 sysctl 来管理服务（例如冷启动），请参阅[Aerospike systemd Daemon Management](https://www.aerospike.com/docs/operations/manage/aerospike/systemd/index.html#coldstart-aerospike-server).